<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1.0"
  />
  <title>Assembly Playground</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=JetBrains+Mono:wght@400;600&display=swap"
    rel="stylesheet"
  />
  <style>
    body {
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu,
        Cantarell, Noto Sans, Helvetica Neue, Arial, "Apple Color Emoji",
        "Segoe UI Emoji";
    }
    .code {
      font-family: "JetBrains Mono", ui-monospace, SFMono-Regular, Menlo,
        Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }
    .split {
      display: grid;
      grid-template-columns: 1fr 10px 1fr;
    }
    .gutter {
      cursor: col-resize;
      background: linear-gradient(
        to right,
        transparent 0,
        transparent 4px,
        rgba(0, 0, 0, 0.08) 5px,
        transparent 6px,
        transparent 10px
      );
    }
  </style>
</head>
<body class="bg-gray-50 text-gray-900 min-h-screen">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <header class="mb-6">
      <div class="flex items-center justify-between">
        <div>
          <h1 class="text-2xl sm:text-3xl font-semibold tracking-tight">
            Assembly Playground
          </h1>
          <p class="text-gray-500 mt-1">
            Type assembly on the left. Output updates automatically.
          </p>
        </div>
        <span class="text-sm text-gray-500">Flask + binutils</span>
      </div>
    </header>

    <!-- Toolbar -->
    <div
      class="sticky top-0 z-10 bg-white/70 backdrop-blur border border-gray-200 rounded-lg p-3 mb-4"
    >
      <div class="flex flex-wrap items-center gap-3 justify-between">
        <div class="flex items-center gap-4">
          <span class="text-sm text-gray-600">Output format:</span>
          <label class="inline-flex items-center gap-2">
            <input
              type="radio"
              name="output-format"
              value="hex"
              class="text-blue-600"
              checked
            />
            <span class="text-sm">Hex</span>
          </label>
          <label class="inline-flex items-center gap-2">
            <input
              type="radio"
              name="output-format"
              value="objdump"
              class="text-blue-600"
            />
            <span class="text-sm">Objdump</span>
          </label>
        </div>

        <div class="flex items-center gap-2">
          <button
            id="force-compile"
            class="px-3 py-1.5 rounded-md border text-sm bg-white hover:bg-gray-50 border-gray-200"
            title="Ctrl/Cmd+Enter"
          >
            Recompile
          </button>
          <button
            id="clear-input"
            class="px-3 py-1.5 rounded-md border text-sm bg-white hover:bg-gray-50 border-gray-200"
            title="Ctrl/Cmd+L"
          >
            Clear
          </button>
        </div>
      </div>
    </div>

    <!-- Error Banner -->
    <div
      id="error-container"
      class="hidden mb-4 border-l-4 border-red-500 bg-red-50 text-red-800 rounded-md"
    >
      <div class="p-3 text-sm">
        <span id="error-message"></span>
      </div>
    </div>

    <!-- Split view -->
    <div class="split h-[70vh] min-h-[480px]">
      <!-- Left: editor -->
      <div
        class="bg-white border border-gray-200 rounded-l-lg overflow-hidden flex flex-col"
      >
        <div class="px-4 py-2 border-b border-gray-100 text-sm text-gray-600">
          Editor
        </div>
        <textarea
          id="assembly-input"
          class="code flex-1 w-full resize-none p-4 outline-none text-sm leading-6 bg-white"
          spellcheck="false"
          placeholder="trap 0"
        >trap 0</textarea>
        <div class="px-4 py-2 border-t border-gray-100 text-xs text-gray-400">
          Tips: Ctrl/Cmd+Enter to recompile Â· Ctrl/Cmd+L to clear
        </div>
      </div>

      <!-- Gutter -->
      <div id="gutter" class="gutter"></div>

      <!-- Right: output -->
      <div
        class="bg-white border border-gray-200 rounded-r-lg overflow-hidden flex flex-col"
      >
        <div
          class="px-4 py-2 border-b border-gray-100 flex items-center justify-between"
        >
          <div class="flex items-center gap-3 text-sm">
            <span class="text-gray-600">Output</span>
            <span
              id="active-format"
              class="px-2 py-0.5 rounded bg-gray-100 text-gray-700"
              >Hex</span
            >
          </div>
          <div class="flex items-center gap-2">
            <button
              id="copy-btn"
              class="px-3 py-1.5 rounded-md border text-sm bg-white hover:bg-gray-50 border-gray-200 hidden"
            >
              Copy
            </button>
          </div>
        </div>
        <div
          class="flex-1 overflow-auto p-4 bg-gray-50/70 border-t border-gray-100"
        >
          <pre
            id="output"
            class="code text-sm leading-6 whitespace-pre-wrap"
          ></pre>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div
    id="toast"
    class="fixed bottom-4 left-1/2 -translate-x-1/2 px-4 py-2 rounded-md text-sm bg-gray-900 text-white opacity-0 pointer-events-none transition-opacity"
    role="status"
    aria-live="polite"
  >
    Copied to clipboard
  </div>

  <script>
    // Simple split resize
    (function enableSplit() {
      const gutter = document.getElementById("gutter");
      const container = gutter.parentElement;
      let dragging = false;

      gutter.addEventListener("mousedown", (e) => {
        dragging = true;
        document.body.classList.add("select-none");
        e.preventDefault();
      });

      window.addEventListener("mousemove", (e) => {
        if (!dragging) return;
        const rect = container.getBoundingClientRect();
        let x = e.clientX - rect.left;
        const min = 240;
        const max = rect.width - 240;
        x = Math.max(min, Math.min(max, x));
        const leftPx = x;
        const rightPx = rect.width - x - gutter.offsetWidth;
        container.style.gridTemplateColumns = `${leftPx}px 10px ${rightPx}px`;
      });

      window.addEventListener("mouseup", () => {
        if (!dragging) return;
        dragging = false;
        document.body.classList.remove("select-none");
      });
    })();

    document.addEventListener("DOMContentLoaded", function () {
      const STORAGE_KEY = "assembly_input_v1";
      const FORMAT_KEY = "assembly_output_format_v1";

      const errorContainer = document.getElementById("error-container");
      const errorMessage = document.getElementById("error-message");
      const output = document.getElementById("output");
      const copyBtn = document.getElementById("copy-btn");
      const toast = document.getElementById("toast");
      const assemblyInput = document.getElementById("assembly-input");
      const formatRadios = document.querySelectorAll(
        'input[name="output-format"]'
      );
      const activeFormat = document.getElementById("active-format");
      const forceBtn = document.getElementById("force-compile");
      const clearBtn = document.getElementById("clear-input");

      let debounceTimer = null;

      function loadSavedInput() {
        try {
          const v = localStorage.getItem(STORAGE_KEY);
          return typeof v === "string" ? v : "";
        } catch {
          return "";
        }
      }

      function saveInput(value) {
        try {
          localStorage.setItem(STORAGE_KEY, value ?? "");
        } catch {}
      }

      function currentFormat() {
        const el = document.querySelector(
          'input[name="output-format"]:checked'
        );
        return el ? el.value : "hex";
      }

      function setActiveFormatBadge() {
        activeFormat.textContent =
          currentFormat() === "objdump" ? "Objdump" : "Hex";
      }

      function showOutput(text) {
        output.textContent = text || "";
        if (text && text.length > 0) {
          copyBtn.classList.remove("hidden");
        } else {
          copyBtn.classList.add("hidden");
        }
      }

      function showError(message) {
        errorMessage.textContent = message;
        errorContainer.classList.remove("hidden");
      }

      function hideError() {
        errorContainer.classList.add("hidden");
      }

      function showToast(msg = "Copied to clipboard") {
        toast.textContent = msg;
        toast.classList.remove("opacity-0");
        toast.classList.add("opacity-100");
        setTimeout(() => {
          toast.classList.remove("opacity-100");
          toast.classList.add("opacity-0");
        }, 1400);
      }

      function debounceCompile(ms = 350) {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(compile, ms);
      }

      function compile() {
        const code = assemblyInput.value.trim();
        if (!code) {
          showOutput("");
          showError("Please enter assembly code");
          return;
        }

        hideError();

        fetch("/compile", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            assembly: code,
            format: currentFormat(),
          }),
        })
          .then((res) =>
            res.json().then((data) => ({
              ok: res.ok,
              data,
            }))
          )
          .then(({ ok, data }) => {
            showOutput(data.output || "");
            if (!ok || data.error) {
              // Show blacklist or other errors but keep output visible
              showError(data.error || "Unknown error");
            } else {
              hideError();
            }
          })
          .catch((err) => {
            showError(err?.message || "Request failed");
          });
      }

      // Restore persisted input
      const saved = loadSavedInput();
      if (saved && saved.trim().length > 0) {
        assemblyInput.value = saved;
      }

      // Restore persisted format
      const savedFmt = localStorage.getItem(FORMAT_KEY);
      if (savedFmt === "hex" || savedFmt === "objdump") {
        const el = document.querySelector(
          `input[name="output-format"][value="${savedFmt}"]`
        );
        if (el) el.checked = true;
      }
      setActiveFormatBadge();

      // Events
      assemblyInput.addEventListener("input", () => {
        saveInput(assemblyInput.value);
        debounceCompile();
      });

      formatRadios.forEach((r) =>
        r.addEventListener("change", () => {
          localStorage.setItem(FORMAT_KEY, currentFormat());
          setActiveFormatBadge();
          debounceCompile(120);
        })
      );

      forceBtn.addEventListener("click", compile);

      clearBtn.addEventListener("click", () => {
        assemblyInput.value = "";
        localStorage.removeItem(STORAGE_KEY);
        showOutput("");
        showError("Please enter assembly code");
        assemblyInput.focus();
      });

      copyBtn.addEventListener("click", function () {
        const textToCopy = output.innerText;
        if (!textToCopy) return;
        navigator.clipboard
          .writeText(textToCopy)
          .then(() => showToast())
          .catch(() => showToast("Copy failed"));
      });

      // Keyboard shortcuts
      window.addEventListener("keydown", (e) => {
        const accel = (e.ctrlKey || e.metaKey) && !e.shiftKey && !e.altKey;
        if (accel && e.key.toLowerCase() === "enter") {
          e.preventDefault();
          compile();
        }
        if (accel && e.key.toLowerCase() === "l") {
          e.preventDefault();
          clearBtn.click();
        }
      });

      // Initial compile
      compile();
    });
  </script>
</body>
</html>
